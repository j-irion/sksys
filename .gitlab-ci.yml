variables:
  RUST_MSRV: "1.69.0"

stages:
  - lint
  - build

check-cargo-fmt:
  image: cimg/rust:$RUST_MSRV
  stage: lint
  script:
    - cargo fmt --check --all

check-cargo-clippy:
  image: cimg/rust:$RUST_MSRV
  stage: lint
  script:
    - cargo clippy

check-prettier:
  image: node:latest
  stage: lint
  script:
    - yarn --frozen-lockfile
    - yarn prettier --check .

validate-terraform 1/2:
  image: alpine
  stage: lint
  script:
    - apk add terraform
    - terraform -chdir=infra/dev init
    - terraform -chdir=infra/dev validate

validate-terraform 2/2:
  image: alpine
  stage: lint
  script:
    - apk add terraform
    - terraform -chdir=infra/gitlab-runner init
    - terraform -chdir=infra/gitlab-runner validate

build-aggregator:
  image: cimg/rust:$RUST_MSRV
  stage: build
  script:
    - cargo build -p aggregator
