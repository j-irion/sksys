variables:
  RUST_MSRV: "1.69.0"
  CARGO_HOME: "$CI_PROJECT_DIR/.cache/cargo"

cache:
  paths:
    - .cache/cargo
    - target

stages:
  - format
  - lint
  - build

format-cargo-fmt:
  image: cimg/rust:$RUST_MSRV
  stage: format
  script:
    - cargo fmt --check --all

format-prettier:
  image: node:latest
  stage: format
  script:
    - yarn --frozen-lockfile
    - yarn prettier --check .

check-aggregator:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes:
        - backend/aggregator/**/*
  image: cimg/rust:$RUST_MSRV
  stage: lint
  script:
    - cargo clippy -p aggregator --locked

check-ingester:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes:
        - backend/ingester/**/*
  image: cimg/rust:$RUST_MSRV
  stage: lint
  script:
    - cargo clippy -p aggregator --locked

validate-terraform 1/3:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes:
        - infra/dev/**/*
  image: alpine
  stage: lint
  script:
    - apk add terraform
    - terraform -chdir=infra/dev init
    - terraform -chdir=infra/dev validate

validate-terraform 2/3:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes:
        - infra/gitlab-runner/**/*
  image: alpine
  stage: lint
  script:
    - apk add terraform
    - terraform -chdir=infra/gitlab-runner init
    - terraform -chdir=infra/gitlab-runner validate

validate-terraform 3/3:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes:
        - infra/gce-compute/**/*
  image: alpine
  stage: lint
  script:
    - apk add terraform
    - terraform -chdir=infra/gitlab-runner init
    - terraform -chdir=infra/gitlab-runner validate

build-aggregator:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes:
        - backend/aggregator/**/*
  image: cimg/rust:$RUST_MSRV
  stage: build
  script:
    - cargo build -p aggregator

build-ingester:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes:
        - backend/ingester/**/*
  image: cimg/rust:$RUST_MSRV
  stage: build
  script:
    - cargo build -p ingester
